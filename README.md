
# 🏮 MTU-JSON-GUI (Ultimate Edition)

### 专业的日漫汉化可视化排版工作站

**MTU-JSON-GUI** 是一款专为日漫汉化器 https://github.com/hgmzhn/manga-translator-ui 量身定制的 Web 端可视化嵌字工具。它不仅能处理文本替换，更内置了一套精密平衡的**几何排版引擎**，旨在通过算法自动化解决日漫排版中繁琐的对齐、间距与透视问题。

---

## 🏗️ 核心黑科技：全场景排版引擎

### 1. 极致的对齐与排版控制

工具提供了四种针对漫画对话框优化的排版模式，支持实时切换：

* **块居中 (Block-Center-Top)**：将整个文本块作为一个整体在对话框内居中，保持行间逻辑一致。
* **块首对齐 (Block-Top)**：文本块整体向对话框顶部（横排）或右侧（竖排）对齐。
* **块尾对齐 (Block-Bottom)**：文本块整体向对话框底部（横排）或左侧（竖排）对齐。
* **单列居中 (Column-Center)**：可使每一列文字独立居中。

### 2. 万能标点对齐算法 (Ink-Middle Alignment)

* **字体无关居中**：不论使用何种字库，系统通过测量字符墨迹的真实物理边界（`actualBoundingBox`），计算其几何中心（`inkMiddle`），确保“！”、“？”等标点符号在任何字体下都能精准对齐中轴线。
* **智能压缩与贴边**：自动识别前/后括号及句读点，根据排版方向动态执行压缩和贴边补偿，消除视觉上的散乱感。

---

## 🤖 像素级自动化套件

* **智能自动换行 (Auto-Wrap)**：基于像素宽度的精确拆分。竖排自动分列，横排自动分行，且能完美保持富文本标签（如加粗、颜色、注音）在换行后的属性继承。
* **感知式自动字号 (Auto FontSize)**：通过 100px 基准预渲染测量，根据文本框的物理空间自动推导出最契合的字号。
* **动态自动行距 (Auto Line Spacing)**：自动分析 OCR 原始行块的投影距离，一键还原原版漫画的行分布比例。
* **自动 TCY (纵中横)**：智能识别 2-4 位数字并执行 90° 旋转排版，适配日文竖排习惯。

---

## 🛠️ 交互与进阶工具箱

### 几何修正系统

* **斜 (Slanted)**：智能探测文字向量，自动同步外壳框的角度。
* **直 (Straight)**：一键强制归零角度，将倾斜框转正。
* **🔗 合并 (Merge)**：支持多选 Line 框，可将误合并的文本块一键合并为整体区块，剩余未选中的行自动合成一块。
* **🔪 拆分 (Split)**：可将误合并的文本行拆分为独立行。

### 未来功能路线图 (Roadmap)

* **🔄 批量替换与排序**：支持全局关键词替换，以及手动调整框体的渲染叠放顺序。
* **矩形化与扶正**：快速将透视扭曲的多边形恢复为标准矩形视角。
---

## ⌨️ 效率专家快捷键

| 快捷键 | 功能说明 |
| --- | --- |
| **A / D** | 循环选中画布中的文本框 |
| **← / →** | 批量模式下的页面翻转（自动保存当前进度） |
| **[ / ]** | 步进调整字号大小 (±0.5px) |
| **Space (长按)** | 开启自由平移模式（抓手） |
| **Delete** | 删除当前选中的行或区域 |
| **Shift + 点击** | 进入多选模式，用于合并或批量属性修改 |
---

您的项目 `MTU-JSON-GUI` 中最核心的“黑科技”之一就是那套基于正则表达式和 Canvas 变换的**富文本解析引擎**。它不仅支持基础样式，还包含了一套复杂的**几何变换指令**，专门用于模拟漫画中各种扭曲、透视和装饰性排版。

以下是为您整理的 GitHub 仓库中关于**富文本功能**的专项介绍：

---

## 🎨 深度富文本指令系统 (Rich Text Engine)

MTU 内置了一套专为漫画优化的标签系统，支持在单行文本内混用多种样式。系统会实时将标签解析为 Canvas 的绘制状态机，支持多级嵌套与属性继承。

### 1. 全标签功能速查表

| 标签 | 功能描述 | 示例与参数说明 |
| --- | --- | --- |
| **`[b]`** | **文本加粗** | `[b]粗体文字[/b]`，对接 `fontWeight` 系统。 |
| **`[i]`** | **斜体/水平切变** | `[i]常规斜体[/i]` 或 `[i=15]` 指定切变角度。 |
| **`[v]`** | **垂直切变** | `[v=15]` 模拟垂直方向的透视扭曲，常用于侧面墙壁的台词。 |
| **`[rot]`** | **字符旋转** | `[rot=45]` 使文字在其中心点处旋转特定角度。 |
| **`[r=]`** | **Ruby 注音** | `[r=せんせい]先生[/r]`，自动适配字号比例并处理重叠避让。 |
| **`[t]`** | **强制纵中横** | `[t]99[/t]` 在竖排模式下强制将内容横向排列（TCY）。 |
| **`[d]`** | **着重号** | `[d]重点[/d]` 在文字侧边添加日式着重小圆点。 |
| **`[s=]`** | **局部字号倍率** | `[s=1.5]` 将局部文字放大为基准字号的 1.5 倍。 |
| **`[f=]`** | **局部更换字体** | `[f=SimSun]` 为特定词汇指定不同的字体名称。 |
| **`[k=]`** | **字距调整** | `[k=0.2]` 调整局部字符间的间距倍率。 |
| **`[x]` / `[y]`** | **坐标偏移** | `[x=5][y=-2]` 对文字执行像素级的微调位移。 |
| **`[m]`** | **水平镜像** | `[m]镜像[/m]` 实现文字的水平左右翻转。 |
| **`[mv]`** | **竖向镜像** | `[mv]倒影[/mv]` 实现文字的垂直上下翻转。 |

### 2. 硬核技术特性

#### 📐 旋转坐标系下的“逻辑互换”

在竖排模式（Vertical）中，当字符被旋转 90 度以适配排版方向时，MTU 实现了智能的切变逻辑互换：

* **自动修正**：系统会自动将 `[i]` (SkewX) 与 `[v]` (SkewY) 的变换矩阵进行映射重组，确保在 90 度旋转后，用户输入的“水平斜体”在视觉上依然符合直觉，而非产生错误的拉伸。

#### 🛡️ 智能避让与堆叠 (Avoidance Logic)

* **Ruby 与 Dot 共存**：当一行文字同时拥有 `[r]` (注音) 和 `[d]` (着重号) 时，系统会自动计算动态间距。着重号会检测本行是否存在 Ruby，并自动向外平移，防止视觉元素重叠冲突。
* **动态 Ruby 缩放**：当注音内容过长时，系统会自动从“等距分布”切换为“比例挤压”模式，确保注音不会超出正文词组的物理边界。

#### 🎯 像素级标点居中 (Ink-Middle Alignment)

* **几何重心对齐**：不论是 `！`、`？` 还是 `...`，系统在渲染时都会实时测量其墨迹的几何中心。
* **非占位符对齐**：摒弃了传统字库的排版占位逻辑，通过 `actualBoundingBox` 计算，实现标点符号无论在何种字体下都能在对话框内绝对居中。

---

## 🎨 核心黑科技：全能描边与视觉系统

针对 Canvas 渲染大字号描边时的缺陷，MTU 开发了独有的渲染方案：

* **强力填孔描边 (Fill-Holes System)**：
* **技术原理**：采用独创的“向心圆叠加算法”（Concentric Rendering）。通过从最大线宽向内步进循环渲染描边，彻底消除传统 Canvas 描边在处理复杂汉字或大字号时出现的内部空心、锯齿和破碎现象。
* **视觉效果**：提供极其扎实、饱满的文字边缘，完美复刻商业漫画的嵌字质感。


* **智能白色探测 (Auto-White Detection)**：
* 系统会自动检测文字颜色。当识别到浅色或接近白色的文字时，会自动为其开启 0.2 倍率的黑色描边，确保文字在任何背景下都具备清晰的可读性。


* **多维视觉效果**：
* 支持实时调节描边粗细（基于字号比例）、描边圆角（Round Join）与斜角（Miter Join）切换。
* 内置 **Glow/Blur (发光)** 系统，支持自定义发光半径与颜色，常用于营造对话框背景氛围。



# 🏮 MTU-JSON-GUI (Ultimate Edition) 使用指南

**MTU-JSON-GUI** 是一款专为漫画汉化设计的专业级可视化排版工作站。它通过像素级的渲染算法，实现了从 OCR 数据到最终嵌字成稿的全自动化与精细化控制。

---

## 📂 第一部分：核心导入指南 (Import Guide)

本工具的导入系统具备智能识别逻辑，建议严格遵守以下命名规范以获得最佳体验：

### 1. 命名规范与智能匹配

为了实现图片、JSON 数据与修复图（去字图）的“秒速连连看”，请确保文件名符合以下规则：

* **原图**：`001.jpg`
* **JSON 数据**：`001_translations.json` (必须包含 `_translations` 后缀)
* **修复图 (选填)**：`001_inpainted.jpg` 或 `001.png` (系统会自动去除 `_inpainted`, `_fixed`, `_mask` 等后缀进行匹配)

### 2. 导入模式选择

* **单文件模式**：点击顶栏“单 JSON”和“单图片”按钮，手动配对单个页面。
* **批量文件夹模式 (推荐)**：
1. 点击 **“批量图片”**，选择包含所有原图的文件夹。
2. 点击 **“批量 JSON”**，选择包含所有翻译数据的文件夹。
3. 系统将自动执行**自然数排序**（确保 2.jpg 在 10.jpg 前面）并激活右侧分页导航栏。
4. **智能修复图载入**：若有 LaMa 或其他工具生成的去字图，点击“批量修复”即可自动替换背景底图。



---

## 📐 第二部分：专业排版与对齐 (Layout)

工具提供了四种针对漫画气泡优化的排版对齐模式：

1. **块居中 (Block-Center-Top)**：默认模式。将所有行视为一个整体矩形，在框内执行几何居中，保持段落感。
2. **块首/块尾对齐 (Block-Top / Bottom)**：整体向气泡顶部或底部（横排）/ 右侧或左侧（竖排）贴齐。
3. **单列/单行居中 (Column-Center)**：**异形气泡神器**。每一行文字独立寻找中轴线居中，完美适配爆炸框或长条形气泡。
4. **标点物理纠偏 (Ink-Middle)**：系统通过计算字符墨迹的真实几何中心（非字库占位符中心），确保“！”、“？”等符号在任何字体下都能视觉居中。

---

## 🤖 第三部分：自动化与一键处理 (Automation)

针对工业化嵌字流程，右侧边栏提供了高效的“一键”套件：

* **一 (一键全自动)**：依次执行“Angle 规则替换”+“自动字号”+“自动行距”，瞬间完成全书初稿。
* **替 (正则替换)**：内置针对标点纠偏的固定规则（如将 `！！！` 替换为双惊叹号 `‼`）。
* **自 (自动字号/行距)**：
* **FontSize**：基于 100px 测量基准，根据气泡物理空间反向推算最佳字号。
* **LineSpacing**：基于 OCR 原始坐标投影，还原漫画原稿的行间比例。



---

## ✍️ 第四部分：高级编辑与富文本 (Advanced Editing)

### 1. 结构化交互

* **合 (Merge)**：按住 **Shift** 键在画布上点击选中多个行框，点击“合”即可将其归并为一个总框，并保留已有的翻译片段。
* **拆 (Split)**：选中多行翻译中的某一行，点击“拆”即可将其精准剥离为独立的新框，方便单独微调位置。
* **属 (Switch)**：一键切换当前选中框的横向/竖向排版属性。

### 2. 深度富文本标签

| 标签 | 功能 | 标签 | 功能 |
| --- | --- | --- | --- |
| `[b]` | 加粗 | `[r=注音]` | Ruby 注音 (支持挤压缩放) |
| `[v=15]` | **垂直切变** (模拟侧视透视) | `[rot=45]` | 字符级旋转 |
| `[t]` | 强制纵中横 (TCY) | `[d]` | 着重号 (自动避让注音) |
| `[m] / [mv]` | 水平 / 垂直镜像 | `[k=0.2]` | 局部字距调整 |

---

## ⌨️ 第五部分：效率快捷键 (Shortcuts)

| 按键 | 功能描述 |
| --- | --- |
| **A / D** | 循环选中 画布中的 翻译框 |
| **← / →** | 批量模式下的 页面切换（翻页即自动保存） |
| **[ / ]** | 步进调整选中框的字号大小 (±0.5px) |
| **Space (长按)** | 自由平移画布 (抓手模式) |
| **Delete** | 删除选中的行或整个翻译区块 |
| **Shift + 点击** | 多选模式：用于合并框体或批量修改属性 |

---

## 💾 第六部分：导出结果

* **图片导出**：支持后台离线渲染，点击“💾 导出”后，系统将遍历所有页面，渲染复杂的描边、发光与富文本效果，最终打包为包含所有已嵌字图片的 `.zip` 压缩包。
* **数据保存**：在批量模式下，翻页和导出操作均会自动同步最新的坐标与文本修改至内存。

---

**提示：** 针对 Canvas 渲染大字号时的空心问题，请务必勾选 **“填孔”** 开关，系统将启动向心圆叠加渲染算法。
